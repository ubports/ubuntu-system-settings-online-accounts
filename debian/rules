#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)

# Skip tests on the archs they are known to be flaky with current configuration
# See https://launchpad.net/bugs/1606927
testskip_architectures := powerpc

override_dh_auto_configure:
	dh_auto_configure -- \
		LIBDIR=/usr/lib/$(DEB_HOST_MULTIARCH) \
		DEB_HOST_MULTIARCH=$(DEB_HOST_MULTIARCH) \
		"QMAKE_CXXFLAGS=$(CFLAGS)" \
		CONFIG+=enable-mir \
		CONFIG+=ubuntu-docs \
		ubuntu-system-settings-online-accounts.pro

override_dh_auto_test:
ifneq ($(DEB_HOST_ARCH),$(findstring $(DEB_HOST_ARCH), $(testskip_architectures)))
	dh_auto_test
endif

override_dh_install:
	rm -rf debian/*/usr/lib/x86_64-linux-gnu/libonline-accounts-plugin.so
	rm -rf debian/*/usr/share/accounts/qml-plugins/example
	rm -rf debian/*/usr/share/accounts/providers/example.provider
	rm -rf debian/*/usr/tests
	dh_install --fail-missing

%:
	dh $@ --with python3
